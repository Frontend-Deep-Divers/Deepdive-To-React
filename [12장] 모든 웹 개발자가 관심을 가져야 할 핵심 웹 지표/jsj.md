# 12장 모든 웹 개발자가 관심을 가져야할 핵심 웹 지표

## 12.1 웹사이트와 성능

- 웹 사이트의 성능은 다음과 같은 요소에 영향을 미친다.
    - 1초 내로 로딩되는 사이트는 5초 내로 로딩되는 사이트보다 길제 구매로 이어지는 고객 비율이 2.5배 더 높다.
    - 0~5초의 범위에서 1초 로딩이 늦어질 수록 전환율은 4.42%씩 떨어진다. 5초 이상 느려지면 전환율은 20% 가까이 떨어진다는 뜻이다.
    - 페이지 로드 시간이 0~2초 사이인 페이지에서 가장 높은 전환율을 달성할 수 있다.
- 사용자 또한 이러한 성능에 매우 민감하다. 70%는 페이지 속도가 온라인 커머스 사이트를 방문하는데 영향을 주고, 절반 이상이 빠르게 로딩할 수 있다면 애니메이션이나 동영상은 필요 없다고 하였다.
- 전체 웹 페이지를 표시하는데 필요한 최적의 평균 리소스 요청수는 50회 미만이며 평균적으로 웹 페이지 전체를 요청하는데 15.3초가 걸린다.
- 웹 사이트의 성능 또한 개발자의 책임이며 생각보다 웹 사이트 성능이 사용자에게 끼치는 영향은 지대하다.

## 12.2 핵심 웹 지표란?

- 구글에서 만든 지표로, 웹 사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어다.
- 구글에서 핵심 웹 지표로 꼽는 지표는 다음과 같다.
    - 최대 콘텐츠풀 페인트 (LCP)
    - 최초 입력 지연(FID)
    - 누적 레이아웃 이동 (CLS)

## 12.3 최대 콘텐츠풀 페인트 (LCP)

- 페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는데 걸리는 시간
- 뷰포트 : 사용자에게 현재 노출되는 화면. 사용자에게 노출되는 영역은 기기에 의존하므로 뷰포트 크기는 기기마다 다르다.
- 뷰포트 내부에서 ‘큰 이미지와 텍스트’는 다음과 같다.
    - <img>
    - <svg> 내부의 <image>
    - poster 속성을 사용하는 <video>
    - url()을 통해 불러온 배경 이미지가 있는 요소
    - 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소 (<p>, <div> 등이 포함)
- 각 엘리먼트가 등장한 시점부터 텍스트 또는 이미지가 완전히 로딩되는 시점이 사용자의 시점에 노출되는 시점이다.
- 최대 콘텐츠풀 페인트란 사용자의 기기가 노출하는 뷰포트 내부에서 가장 큰 영역을 차지하는 요소가 렌더링되는데 얼마나 걸리는지를 측정하는 지표다.
- 사용자에게 페이지의 정보를 화면에 전달하는 속도를 객관적으로 판단하기 위한 지표로 만들어진 것이 바로 LCP다.
- LCP는 페이지 로딩에 따라 변화하는 지표다. 사용자가 이용하는 디바이스의 크기에 따라, 그것이 이미지와 같은 크기가 큰 리소스라면 실제로 로딩에 필요한 시간에 따라 LCP 지표의 값이 달라질 수 있다.
- LCP에서 2.5초 내면 좋음, 4초 이내면 보통, 그 이상은 나쁨으로 판단한다.
- 개선 방안
    - 텍스트는 언제나 옳다.
        - LCP 지표에서 좋은 점수를 얻는 가장 확실한 방법은 뷰포트 최대 영역, 즉 LCP 예상 영역에 이미지가 아닌 ㅁ누자열을 넣는 것이다.
        - 가능한 해당 영역을 텍스트로 채우는 것이 상책이다.
    - 이미지를 불러오는 방식
        - <img>
            - 이미지는 브라우저의 프리로드 스캐너에 의해서 먼저 발견되어 빠르게 요청이 일어난다.
            - <img> 내부의 리소스는 이처럼 HTML 파싱이 미처 완료되지 않더라도 프리로드 스캐너가 병렬적으로 리소스를 다운로드 하므로 LCP 요소를 불러오기에 적절한 방법이다. 이는 <picture>도 마찬가지다.
            - 프리로드 스캐너 : HTML을 파싱하는 단계를 차단하지 않고 이미지와 같이 빠르게 미리 로딩하면 좋은 리소스를 먼저 찾아 로딩하는 브라우저의 기능
        - <svg> 내부의 <img>
            - <svg> 내부의 <img>가 로딩이 완료되기 전까지는 LCP가 완료되지 않는다. 또한 모든 리소스를 다 불러온 이후에 이미지를 불러오는데 이는 <img>와는 다르다.
            - 즉, <svg> 내부의 <img> 는 프리로드 스캐너에 의해 발견되지 않아 병렬적으로 다운로드가 일어나지 않기에 LCP 점수에도 악영향을 끼친다..
        - <video>의 poster
            - poster는 사용자가 video 요소를 재생하거나 탐색하기 전까지 노출되는 요소다.
            - <img>와 같은 성능을 낸다.
        - background-image
            - CSS에 있는 리소스는 항상 느리다. 이러한 리소스는 브라우저가 해당 리소스를 필요로 하는 DOM을 그릴 준비가 되기 전까지 리소스 요청을 뒤로 미루기 때문이다.
            - LCP같이 중요한 리소스에는 사용하지 않는 것이 좋다.
- 주의 사항
    - 이미지 무손실 압축
        - 웹으로 서비스할 이미지는 가능한 무손실 형식으로 압축해 최소한의 용량으로 서비스 하는 것이 좋다.
    - loading=lazy 주의
        - loading=lazy는 리소스를 중요하지 않음으로 표시하고 필요할 때만 로드하는 전략으로, LCP 콘텐츠의 이미지를 중요하지 않은 리소스로 분류할 수 있기에 LCP 콘텐츠의 이미지에는 사용하지 않는 것이 좋다.
    - fadein과 같은 각종 애니메이션
        - 애니메이션이 걸리는 시간만큼 LCP도 그만큼 늦어진다.
    - 클라이언트에서 빌드하지 말것
    - LCP리소스는 직접 호스팅

## 12.4 최초 입력 지연(FID)

- 사용자가 페이지와 처음 상호 작용할 때부터 해당 상호 작용에 대한 응답으로 브라우저가 실제로 이벤트 핸들러 처리를 시작하기까지의 시간
- 사용자가 얼마나 빠르게 웹페이지와의 상호작용에 대한 응답을 받을 수 있는지에 대해 측정하는 지표다.
- 브라우저의 메인 스레드가 대규모 렌더링 등 다른 작업으로 바쁜 경우 해당 작업을 처리하는데 리소스를 할애하고 있을 때, 자바스크립트 실행 환경은 ‘싱글 스레드’이기 때문에 자바스크립트가 이벤트 리스너와 같은 다른 작업을 실행할 수 없어서 지연이 발생한다.
- 이벤트가 발생하는 시점에 최대한 메인 스레드가 다른 작업을 처리할 수 있도록 여유를 만들어둬야 사용자에게 빠른 반응성을 보장할 수 있다.
- 보통 100ms 이내로 응답이 오면 좋은 점수를 받으며 300ms 이내인 경우 보통, 그 이후는 나쁨으로 처리한다.
- 개선 방안
    - 실행에 오래 걸리는 긴 작업을 분리
        - 메인 스레드를 오래 점유해야 하는 긴 작업은 FID 뿐만 아니라 웹페이지 전반에 악영향을 미친다.
        - 웹 페이지에서 꼭 해야하는 작업이 아니라면 서버로 옮겨서 처리하는 것이 좋다.
        - 긴 작업을 여러개로 분리하여 처리하는 것도 좋다. 보통 50ms 이상 걸리면 오래 걸리는 작업이라 간주한다.
    - 자바스크립트 코드 최소화
        - 웹페이지에서 사용하지 않는 코드들은 지연 로딩 기법이나 사용자가 필요로 하는 순간에 불러오거나 우선순위를 낮춰서 불러오는 것이 좋다.
    - 타사 자바스크립트 코드 실행의 지연
        - 웹페이지의 통계 집계 등을 위해 제3자가 만든 타사 스크립트를 넣는 경우도 많은데, 이 코드의 실행으로 인해 메인 스레드가 잠시 점유되고 안좋은 반응성을 제공할 수도 있다.
        - 이들은 <script>의 async와 defer를 이용해 지연 불러오기를 하는 것이 좋다.

## 12.5 누적 레이아웃 이동(CLS)

- 페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표를 계산하는 것
- 이 지표가 낮을 수록 더 좋다.
- 사용자의 가시적인 콘텐츠에 영향을 미쳐야 하기에 뷰포트 내부의 요소에 대해서만 측정하며 뷰포트 밖의 요소에 대해서는 측정하지 않는다.
- 또한 요소가 추가됐다 하더라도 다른 요소의 시작 위치에 영향을 미치지 않았다면 레이아웃 이동으로 간주되지 않는다.
- 0.1 이하는 좋음, 0.25 이하인 경우 보통이며 이외에는 나쁨이다.
- 개선 방안
    - 삽입이 예상되는 요소를 위한 추가적인 공간 확보
        - 대부분의 큰 누적 레이아웃 이동은 클라이언트에서 삽입되는 동적인 요소로 인해 발생한다.
        - 이러한 영향을 받는 것을 미연에 방지하기 위해 useEffect의 내부에서 요소에 영향을 미치는 작업을 최소화 하는 것이 좋다. useEffect 사용이 불가피하다면 useLayoutEffect 훅을 사용해보는 것도 검토해볼만 하다.
        - 스켈레톤 UI의 사례처럼 동적으로 뜰 것으로 예상되는 공간을 미리 확보해두는 것도 좋다.
        - 서버사이드 렌더링은 동적인 요소의 유무를 사전에 판단해 클라이언트에 HTML을 미리 제공해 주므로 깔끔하게 처리가 가능하다.
    - 폰트 로딩 최적화
        - 폰트 또한 레이아웃 이동을 일으키는 원인중 하나다.
        - FOUT : HTML문서에서 지정한 폰트가 보이지 않고 대체 기본 폰트로 보이고 있다가 뒤늦게 폰트가 적용되는 현상
        - FOIT : HTML 문서에서 지정한 폰트가 보이지 않고, 기본 폰트도 없어서 텍스트가 없는 채로 있다가 뒤늦게 폰트가 로딩되면서 페이지에 렌더링 되는 현상
        - <ling>의 preload를 사용하거나 font-family의 요소들을 활용하여 폰트의 다운로드를 우선순위에 밀어넣고, 빠르게 로딩하는데 실패했다면 기본 폰트를 노출하는 방법을 사용하자
    - 적절한 이미지 크기 설정
        - 반응형으로 이미지 크기를 설정할 경우 (auto) 이미지가 완전히 다운로드되기 전까지 크기를 알 수 없기에 레이아웃 이동이 크게 발생할 수 있다.
        - width, height를 지정하거나 srcset 속성을 통해 브라우저가 상황에 맞게 이미지를 사용할 수 있도록 준비하자.
    

## 이외에도 성능 확인에 중요한 지표들

- 최초 바이트 까지의 시간 (TTFB)
    - 브라우저가 웹페이지의 첫번째 바이트를 수신하는데 걸리는 시간
    - 최초의 응답이 오는 바이트까지가 얼마나 걸리는지를 측정하는 지표다.
    - 600ms 이상 걸릴 경우 개선이 필요하다.
- 최초 콘텐츠풀 페인트 (FCP)
    - 페이지가 로드되기 시작한 시점부터 페이지 콘텐츠의 일부가 화면에 렌더링될 때까지의 시간
    - 1.8초 이내는 좋음, 3.0초 이내는 보통 그 이후는 개선이 필요하다.
    - 개선시 고려 사항
        - 최초 바이트까지의 시간을 개선
        - 렌더링을 가로막는 리소스 최소화
        - Above the Fold에 대한 최적화
        - 페이지 리다이렉트 최소화
        - DOM 크기 최소화